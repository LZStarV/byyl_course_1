# 流程图绘制总结（Thompson 构造）

## 差异概览
- 布局分区：入口（开始/调用/判定）置于左侧，组合构造（连接/选择/闭包/正闭包/可选）分布在右上至右中，返回/合并/输出在右中部，形成由左至右、由下至上的信息流。
- 间距优化：横纵间距显著拉大，右上方密集节点横向分散，避免节点与线条重叠。
- 文案自然语言化：将符号式表达（如 `p={head,tail}`、`a.second→b.first`）改为分行的动词短语（“初始化 p 为头尾片段”“添加 ε 边：a.second → b.first”）。
- 连线有路由：为边设置入口/出口锚点与路径点（points），先水平汇合再垂直回收，减少交叉与穿插。
- 关键锚点固定：保留左下角“引用”节点位置不变，其余节点围绕该约束重新布置。

## 主要改进点
- 分列布局
  - 左列：开始 → 调用构造 → 节点类型判定。
  - 中列：原子片段/字符类片段 → 返回片段 → 合并 → 输出 NFA。
  - 右列：连接/选择/闭包/正闭包/可选（横向拉开）。
- 文案结构
  - 使用分行（HTML 行块或换行符）组织每个节点说明，统一“动词 + 宾语”的语序；每行不超过 18–22 字。
  - 示例：
    - “初始化 p 为头尾片段”
    - “添加 ε 边：a.second → b.first”
    - “取消 a.second 为接受”
    - “输出片段：p / {a.first, b.second}”。
- 连线路径
  - 为远距线添加水平中继路径点（如统一在 y=1100 汇合），再垂直回收至目标节点，避免斜线穿插。
  - 设置 `entryX/entryY` 与 `exitX/exitY` 让线从节点边中点进出，防止压住文本。
- 尺寸与位置
  - 增大右侧节点的 `width/height` 配合分行文本提升可读性；将“返回/合并/输出”置于画布中部，缩短关键回路长度。

## 布局规范
- 三列结构：左（入口/判定）→ 右上（组合构造）→ 右中（返回/合并/输出）。
- 相互连接节点相邻或同列；列间保持至少一个节点宽度的横向空隙。
- 上下间距不少于 60–80 像素，左右间距不少于 120–160 像素。

## 文案规范
- 禁用代码式符号表达；全部使用自然语言分行描述。
- 用动词短语引导步骤：初始化/生成/添加/取消/输出等，结尾明确结果（如“输出片段：p”或“输出 NFA”）。

## 连线规范
- 跨区连线先横向汇合再纵向回收；必要时添加多个路径点以绕开节点区。
- 统一从节点边中点进出；避免连线穿过节点文本区域。

## 版面设置
- 画布建议：`pageWidth≈1400`、`pageHeight≈1000`；右侧节点增多时优先扩宽横向布局。
- 节点采用默认样式（圆角或菱形判定），不使用颜色填充；文本分行提高可读性。

## 约束与固定锚点
- 用户指定的固定锚点（如左下角“引用”）需保持位置不变；围绕其做路径适配与局部增距。
- 右上方密集区域优先横向分散，再使用汇合线统一回收到“返回/合并/输出”。

## 生成时注意事项
- 先规划分列与锚点，再放置节点；最后补连线并设置路径点与锚点。
- 若线条拥挤，优先增加横向间距并添加中继点；避免在节点区内穿线。
- 文案统一动词-宾语结构，确保每节点的输出结果明确（片段或最终 NFA）。

## 快速检查清单（Checklist）
- 布局：三列分区是否形成清晰的信息流？
- 间距：节点与线条是否有足够空间（不重叠）？
- 文案：是否全部为自然语言分行，动词引导？
- 连线：是否使用路径点与锚点减少交叉？
- 锚点：用户指定固定节点位置是否保持不变？
- 版面：画布尺寸与节点大小是否适配当前内容量？

## 新增优化建议与规则
- 水平/垂直对齐：将同类或相邻流程节点尽量放在同一水平线或垂直线上，确保连接线可拉直，关键对齐线可选如 y=120/300/480，x=420/800/1160。
- 路径避让：任何连线不得覆盖节点面积（节点宽高的外接矩形）。若直连会穿越节点，则增加折线的中继点（先横向到公共通道，再纵向入目标），保证完整避让。
- 公共通道重叠：不同起点同终点或同起点不同终点的多条线，先汇入公共水平通道点（如 y=600 的横线，或 x=700/1040 的竖向通道）重叠段，再分流进入各自目标，降低线条数量与交叉。
- 节点尺寸控制：对于分行较多的节点，优先缩小宽度、增大高度的比例以避免过宽导致通道拥挤；文本行宽宜控制在 14–18 字符范围内。
- 长条布局：按“流程顺序”进行长条型排布而非矩形铺陈，入口在左上或左中，输出在右下；中间过程沿主流向依次下移或右移，减少回路交叠。
- 逻辑分组疏离：同组节点之间保持相对紧密，不同组之间拉开更大间距（横向 ≥ 160 像素，纵向 ≥ 80 像素），以便通道穿行且不压线。
- 锚点与路径点计算：
  - 对每条边计算其起点/终点的外接矩形，选择边中点（上/下/左/右）作为入/出锚点以减少覆盖概率。
  - 中继点优先选择“安全带”坐标（不与任何节点矩形相交），并尽量复用同一坐标形成公共通道。
- 版面伸缩：当右侧节点增多时，优先扩展横向（pageWidth 增加）并保持主通道坐标不变；必要时将右列拆分为两列，维持对齐与通道复用。

## 实施步骤（绘制流程）
- 规划主轴与分列：确定入口→判定→分支→返回→合并→输出的主轴位置与对齐线。
- 放置节点：先放入口与判定，再放中列返回/合并/输出，最后按工序依次放置右列的各运算节点。
- 设定锚点：统一从节点边中点进出（entry/exit），避免穿越文本。
- 规划通道：为判定→分支与分支→返回设置公共通道坐标；长距离边先横再竖。
- 校验避让：逐条边检查是否与任一节点外接矩形相交，若相交则调整或增加中继点。
- 收紧与疏离：在不影响可读性的前提下收紧节点宽度，同时保持组间更大间距。
